<!DOCTYPE html> 
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lunar Mission Sustainability Planner</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0a0f1f; color: #e0e0e0; }
    .glass-card { background: rgba(20,28,58,0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; }
    .btn-primary { background-color: #3b82f6; transition: background-color .3s, transform .2s; }
    .btn-primary:hover { background-color: #2563eb; transform: translateY(-2px); }
    input[type="number"].supply-input { background-color: rgba(10,15,31,0.8); border: 1px solid #3b82f6; color: #e0e0e0; border-radius: .375rem; padding: .5rem; font-weight: bold; text-align: center; }
    .loader { border: 4px solid rgba(255,255,255,0.2); border-left-color: #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body class="antialiased">
  <header class="sticky top-0 z-30 glass-card mx-4 mt-4">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-white"><span class="text-blue-400">Lunar</span> Sustainability Planner</h1>
      <nav class="hidden md:flex space-x-6 text-lg">
        <a href="#mission-params" class="hover:text-blue-400">Parameters</a>
        <a href="#supplies" class="hover:text-blue-400">Supplies</a>
        <a href="#impact-dashboard" class="hover:text-blue-400">Dashboard</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto p-4 md:p-6">
    <section id="mission-params" class="py-12">
      <div class="glass-card p-8 text-center mb-8">
        <h2 class="text-3xl font-bold mb-4 text-white">Mission Parameters</h2>
        <div class="grid lg:grid-cols-2 gap-8">
          <div class="space-y-4">
            <label for="missionDuration" class="text-xl font-semibold block">Mission Duration (Days)</label>
            <div class="flex items-center justify-center space-x-4">
              <input type="range" id="missionDuration" min="30" max="1000" value="365" step="5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
              <span id="duration-value" class="text-2xl font-bold text-blue-400 w-20 text-center">365</span>
            </div>
          </div>
          <div class="space-y-4">
            <label for="totalInvestment" class="text-xl font-semibold block">Total Investment ($M)</label>
            <input type="range" id="totalInvestment" min="10" max="500" value="65" step="5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
            <span id="investment-value" class="text-2xl font-bold text-blue-400">$65M</span>
          </div>
        </div>
      </div>

      <section id="supplies" class="py-12">
        <h2 class="text-4xl font-bold text-center mb-8">Initial Mission Supplies (kg)</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-6">
          <div class="glass-card p-4 text-center"><div class="text-4xl">🧤</div><h3 class="text-lg mt-2">Nitrile Gloves</h3><div class="mt-2"><input type="number" id="supply-gloves" value="14.6" class="w-full supply-input"><span class="text-sm text-gray-400">kg</span></div></div>
          <div class="glass-card p-4 text-center"><div class="text-4xl">👕</div><h3 class="text-lg mt-2">Cotton Clothing</h3><div class="mt-2"><input type="number" id="supply-clothing" value="36.5" class="w-full supply-input"><span class="text-sm text-gray-400">kg</span></div></div>
          <div class="glass-card p-4 text-center"><div class="text-4xl">🛍️</div><h3 class="text-lg mt-2">Reclosable Bags</h3><div class="mt-2"><input type="number" id="supply-reclosable_bag" value="14.6" class="w-full supply-input"><span class="text-sm text-gray-400">kg</span></div></div>
          <div class="glass-card p-4 text-center"><div class="text-4xl">🧃</div><h3 class="text-lg mt-2">Drink Pouches</h3><div class="mt-2"><input type="number" id="supply-drink_pouch" value="43.8" class="w-full supply-input"><span class="text-sm text-gray-400">kg</span></div></div>
          <div class="glass-card p-4 text-center"><div class="text-4xl">🍲</div><h3 class="text-lg mt-2">Rehydratable Pouches</h3><div class="mt-2"><input type="number" id="supply-rehydratable_pouch" value="58.4" class="w-full supply-input"><span class="text-sm text-gray-400">kg</span></div></div>
          <div class="glass-card p-4 text-center"><div class="text-4xl">🔥</div><h3 class="text-lg mt-2">Nomex Gear</h3><div class="mt-2"><input type="number" id="supply-nomex_bag" value="7.3" class="w-full supply-input"><span class="text-sm text-gray-400">kg</span></div></div>
          <div class="glass-card p-4 text-center"><div class="text-4xl">🧱</div><h3 class="text-lg mt-2">Zotek F30 Foam</h3><div class="mt-2"><input type="number" id="supply-zotek_foam" value="2.9" class="w-full supply-input"><span class="text-sm text-gray-400">kg</span></div></div>
          <div class="glass-card p-4 text-center"><div class="text-4xl">🔩</div><h3 class="text-lg mt-2">Aluminum Parts</h3><div class="mt-2"><input type="number" id="supply-aluminum_struts" value="1.5" class="w-full supply-input"><span class="text-sm text-gray-400">kg</span></div></div>
        </div>
      </section>

      <div class="text-center mt-10">
        <button id="calculate-btn" class="px-8 py-3 btn-primary text-white font-bold rounded-lg text-xl shadow-lg flex items-center justify-center mx-auto">
          <span>Analyze Mission with Gemini</span>
        </button>
      </div>
    </section>

    <section id="impact-dashboard" class="py-12 hidden">
      <div class="grid lg:grid-cols-2 gap-8 mb-8">
        <div class="glass-card p-8 h-full">
          <h2 class="text-3xl font-bold text-center mb-4">Waste Generation</h2>
          <div class="text-center mb-8">
            <span class="text-xl">Total Waste:</span>
            <span id="total-waste" class="text-3xl font-bold text-blue-400 ml-2"></span>
          </div>
          <div class="w-full max-w-2xl mx-auto h-80"><canvas id="wasteChart"></canvas></div>
        </div>

        <!-- We keep this card, but we won’t fake numbers. It will show N/A unless your backend returns more later. -->
        <div class="glass-card p-8 h-full">
          <h2 class="text-3xl font-bold text-center mb-4">Recycling Potential</h2>
          <div class="text-center mb-8">
            <span class="text-xl">Total Recyclable Mass:</span>
            <span id="recyclable-mass" class="text-3xl font-bold text-green-400 ml-2">—</span>
          </div>
          <div class="w-full mx-auto h-80"><canvas id="recyclingChart"></canvas></div>
        </div>
      </div>

      <div class="glass-card p-8">
        <h2 class="text-3xl font-bold mb-4 text-center">Gemini's Analysis & Insights</h2>
        <pre id="gemini-analysis" class="whitespace-pre-wrap text-lg leading-relaxed"></pre>
      </div>
    </section>

    <div id="loading-indicator" class="hidden justify-center items-center py-12">
      <div class="loader"></div>
      <p class="text-2xl ml-4 text-gray-400">Contacting backend and analyzing with Gemini...</p>
    </div>
  </main>

  <footer class="text-center py-8 text-gray-500"><p>Frontend Interface for Gemini-Powered Backend</p></footer>

  <script>
    // --- UI ELEMENTS ---
    const durationSlider = document.getElementById('missionDuration');
    const investmentSlider = document.getElementById('totalInvestment');
    const durationValue = document.getElementById('duration-value');
    const investmentValue = document.getElementById('investment-value');
    const calculateBtn = document.getElementById('calculate-btn');
    const dashboard = document.getElementById('impact-dashboard');
    const loadingIndicator = document.getElementById('loading-indicator');

    const materials = [
      { id: 'gloves', label: 'Nitrile Gloves' },
      { id: 'clothing', label: 'Cotton Clothing' },
      { id: 'reclosable_bag', label: 'Reclosable Bags' },
      { id: 'drink_pouch', label: 'Drink Pouches' },
      { id: 'rehydratable_pouch', label: 'Rehydratable Pouches' },
      { id: 'nomex_bag', label: 'Nomex Gear' },
      { id: 'zotek_foam', label: 'Zotek F30 Foam' },
      { id: 'aluminum_struts', label: 'Aluminum Parts' }
    ];

    let wasteChart; // Chart.js instance

    // --- HELPERS ---
    function updateSliderValues() {
      durationValue.textContent = durationSlider.value;
      investmentValue.textContent = `$${investmentSlider.value}M`;
    }

    function getNumber(id) {
      const v = parseFloat(document.getElementById(id).value);
      return Number.isFinite(v) ? v : 0;
    }

    function buildPayload() {
      const initialSuppliesKg = {};
      materials.forEach(m => {
        initialSuppliesKg[m.id] = getNumber(`supply-${m.id}`);
      });

      // Convert days → months for backend prompt variety
      const durationDays = getNumber('missionDuration');
      const durationMonths = Math.max(1, Math.round(durationDays / 30));

      return {
        missionDurationMonths: durationMonths,
        // You can add more later (crewSize, habitatVolumeM3, orbit, etc.)
        initialSuppliesKg
      };
    }

    function computeTotals(initialSuppliesKg) {
      const total = Object.values(initialSuppliesKg).reduce((a, b) => a + b, 0);
      return { totalWasteKg: total };
    }

    function renderWasteChart(initialSuppliesKg) {
      const ctx = document.getElementById('wasteChart').getContext('2d');
      if (wasteChart) wasteChart.destroy();

      const labels = materials.map(m => m.label);
      const data = materials.map(m => initialSuppliesKg[m.id] || 0);

      wasteChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            label: 'Mass (kg)',
            data,
            backgroundColor: ['#1d4ed8','#2563eb','#3b82f6','#60a5fa','#93c5fd','#bfdbfe','#dbeafe','#eff6ff'],
            borderColor: '#0a0f1f',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e0e0e0', font: { size: 14 } } }
          }
        }
      });
    }

    // --- MAIN FLOW ---
    async function handleMissionAnalysis() {
      dashboard.classList.add('hidden');
      loadingIndicator.classList.remove('hidden');
      loadingIndicator.classList.add('flex');

      const payload = buildPayload();
      // Debug: see what you send
      console.log('Payload → /analyze', payload);

      try {
        const resp = await fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) throw new Error(`Backend error: ${resp.status}`);

        const result = await resp.json();
        console.log('Response from backend:', result);

        // Update KPI (no mock: this is purely computed from user input)
        const totals = computeTotals(payload.initialSuppliesKg);
        document.getElementById('total-waste').textContent = `${totals.totalWasteKg.toFixed(1)} kg`;

        // We are NOT mocking recycling numbers. Leave them as em-dash unless backend returns them.
        document.getElementById('recyclable-mass').textContent = '—';

        // Chart from real user inputs (not mock)
        renderWasteChart(payload.initialSuppliesKg);

        // Show Gemini analysis text exactly as returned
        document.getElementById('gemini-analysis').textContent =
          result.analysis || 'No analysis returned.';

        // Reveal dashboard
        dashboard.classList.remove('hidden');

      } catch (err) {
        console.error(err);
        alert('Error contacting backend. Check console for details.');
      } finally {
        loadingIndicator.classList.add('hidden');
        loadingIndicator.classList.remove('flex');
      }
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', updateSliderValues);
    [durationSlider, investmentSlider].forEach(s => s.addEventListener('input', updateSliderValues));
    document.getElementById('calculate-btn').addEventListener('click', handleMissionAnalysis);
  </script>
</body>
</html>
